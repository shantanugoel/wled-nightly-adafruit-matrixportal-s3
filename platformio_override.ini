; PlatformIO Override Configuration for Fork
; This file overrides default_envs to build ONLY the Adafruit MatrixPortal ESP32-S3

[platformio]
; Override default environments - build ONLY the matrixportal board
default_envs = adafruit_matrixportal_esp32s3

[esp32s3]
; Inherit from main platformio.ini - these are needed for the matrixportal env
platform = espressif32@ ~6.9.0
platform_packages = 
build_flags = -g
  -DCONFIG_IDF_TARGET_ESP32S3=1
  -D CONFIG_ASYNC_TCP_USE_WDT=0
  -DARDUINO_USB_CDC_ON_BOOT=1 -DARDUINO_USB_MODE=1  ;; for boards with ESP32-S3 USB connector only
lib_deps = 
  ${env.lib_deps}

[env:adafruit_matrixportal_esp32s3]
; ESP32-S3 processor, 8 MB flash, 2 MB of PSRAM, dedicated driver pins for HUB75
board = adafruit_matrixportal_esp32s3_wled ; modified board definition: removed flash section that causes FS erase on upload
platform = ${esp32s3.platform}
platform_packages =
upload_speed = 921600
build_unflags = ${common.build_unflags}
build_flags = ${common.build_flags} ${esp32s3.build_flags} -D WLED_RELEASE_NAME=\"MatrixPortal_ESP32-S3\"
  -DARDUINO_USB_CDC_ON_BOOT=1 ;; for boards with USB-OTG connector only (USBCDC or "TinyUSB")
  -DBOARD_HAS_PSRAM
  -DLOLIN_WIFI_FIX ; seems to work much better with this
  -D WLED_WATCHDOG_TIMEOUT=0
  -D WLED_ENABLE_HUB75MATRIX -D NO_GFX
  -D S3_LCD_DIV_NUM=20 ;; Attempt to fix wifi performance issue when panel active with S3 chips
  -D ARDUINO_ADAFRUIT_MATRIXPORTAL_ESP32S3
  -D SR_DMTYPE=1 -D I2S_SDPIN=-1 -D I2S_CKPIN=-1 -D I2S_WSPIN=-1 -D MCLK_PIN=-1  ;; Disable to prevent pin clash

lib_deps = ${esp32s3.lib_deps}
  https://github.com/mrfaptastic/ESP32-HUB75-MatrixPanel-DMA.git#aa28e2a ;; S3_LCD_DIV_NUM fix

board_build.partitions = tools/WLED_ESP32_8MB.csv
board_build.f_flash = 80000000L
board_build.flash_mode = qio
monitor_filters = esp32_exception_decoder
custom_usermods = audioreactive
