name: Nightly MatrixPortal Build

on:
  # Run every night at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering from the web interface
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build MatrixPortal ESP32-S3
    runs-on: ubuntu-latest
    steps:
      - name: Clone upstream WLED
        uses: actions/checkout@v4
        with:
          repository: wled/WLED
          path: WLED
      
      - name: Get upstream commit SHA
        id: upstream
        run: echo "sha=$(git -C WLED rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Activate upstream override config
        run: cp WLED/platformio_override.sample.ini WLED/platformio_override.ini
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'WLED/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'WLED/package-lock.json'
      
      - name: Install Node dependencies and set version
        working-directory: WLED
        run: |
          npm ci
          VERSION=`date +%y%m%d0`
          sed -i -r -e "s/define VERSION .+/define VERSION $VERSION/" wled00/wled.h
      
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.buildcache
            WLED/build_output
          key: pio-${{ runner.os }}-matrixportal-${{ hashFiles('WLED/platformio.ini') }}
          restore-keys: pio-${{ runner.os }}-matrixportal-
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'WLED/requirements.txt'
      
      - name: Install PlatformIO
        run: pip install -r WLED/requirements.txt
      
      - name: Build firmware
        working-directory: WLED
        run: pio run -e adafruit_matrixportal_esp32s3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-matrixportal-esp32s3
          path: |
            WLED/build_output/release/*.bin
            WLED/build_output/release/*.bin.gz
      
      - name: Save upstream commit SHA
        run: echo "${{ steps.upstream.outputs.sha }}" > upstream-sha.txt
      
      - name: Upload SHA artifact
        uses: actions/upload-artifact@v4
        with:
          name: upstream-sha
          path: upstream-sha.txt

  release:
    name: Create Nightly Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout this repo (for extra assets)
        uses: actions/checkout@v4
      
      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-matrixportal-esp32s3
      
      - name: Download SHA artifact
        uses: actions/download-artifact@v4
        with:
          name: upstream-sha
      
      - name: Read upstream SHA
        id: upstream
        run: echo "sha=$(cat upstream-sha.txt)" >> $GITHUB_OUTPUT
      
      - name: Show files
        run: ls -la
      
      - name: Update Nightly Release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly
          name: 'MatrixPortal Nightly Build $$'
          prerelease: true
          body: |
            Automated nightly build for Adafruit MatrixPortal ESP32-S3.
            
            Built from upstream WLED commit: https://github.com/wled/WLED/commit/${{ steps.upstream.outputs.sha }}
            Build date: ${{ github.event.repository.updated_at }}
            
            ## Installation
            Download the `.bin` file and flash using the web installer or esptool.
            
            ## Additional Files
            - `tinyuf2-adafruit_matrixportal_s3-0.35.0-combined.bin` - TinyUF2 bootloader
            - `partitions_8MB_tinyuf2.bin` - Partition table for TinyUF2
          files: |
            *.bin
            *.bin.gz
