name: Nightly MatrixPortal Build

on:
  # Run every night at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering from the web interface
  workflow_dispatch:

jobs:
  build:
    name: Build MatrixPortal ESP32-S3
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo (for override config)
        uses: actions/checkout@v4
        with:
          path: config
      
      - name: Clone upstream WLED
        uses: actions/checkout@v4
        with:
          repository: wled/WLED
          path: WLED
      
      - name: Copy override config to WLED
        run: cp config/platformio_override.ini WLED/
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'WLED/.nvmrc'
          cache: 'npm'
          cache-dependency-path: 'WLED/package-lock.json'
      
      - name: Install Node dependencies and set version
        working-directory: WLED
        run: |
          npm ci
          VERSION=`date +%y%m%d0`
          sed -i -r -e "s/define VERSION .+/define VERSION $VERSION/" wled00/wled.h
      
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.buildcache
            WLED/build_output
          key: pio-${{ runner.os }}-matrixportal-${{ hashFiles('WLED/platformio.ini', 'config/platformio_override.ini') }}
          restore-keys: pio-${{ runner.os }}-matrixportal-
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'WLED/requirements.txt'
      
      - name: Install PlatformIO
        run: pip install -r WLED/requirements.txt
      
      - name: Build firmware
        working-directory: WLED
        run: pio run -e adafruit_matrixportal_esp32s3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-matrixportal-esp32s3
          path: |
            WLED/build_output/release/*.bin
            WLED/build_output/release/*.bin.gz

  release:
    name: Create Nightly Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-matrixportal-esp32s3
      
      - name: Show files
        run: ls -la
      
      - name: Update Nightly Release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly
          name: 'MatrixPortal Nightly Build $$'
          prerelease: true
          body: |
            Automated nightly build for Adafruit MatrixPortal ESP32-S3.
            
            Built from upstream WLED: https://github.com/wled/WLED
            Build date: ${{ github.event.repository.updated_at }}
            
            ## Installation
            Download the `.bin` file and flash using the web installer or esptool.
          files: |
            *.bin
            *.bin.gz
